<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenClaw RAG â€” à¸—à¸”à¸ªà¸­à¸šà¹à¸Šà¸—</title>
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="chat.css" />
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js?v=2"></script>
</head>

<body>
    <div class="orb orb-1" aria-hidden="true"></div>
    <div class="orb orb-2" aria-hidden="true"></div>

    <div class="chat-wrapper">

        <!-- Header -->
        <header class="chat-header fade-up">
            <div class="header-badge"><span class="dot"></span>RAG Chat Â· phaya.io + Supabase</div>
            <div class="chat-header-row">
                <div>
                    <h1>ğŸ’¬ à¹à¸Šà¸— RAG à¸ à¸²à¸©à¸²à¹„à¸—à¸¢</h1>
                    <p>à¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¹€à¸­à¸à¸ªà¸²à¸£à¸—à¸µà¹ˆà¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹à¸¥à¹‰à¸§</p>
                </div>
                <a href="index.html" class="btn btn-secondary" style="text-decoration:none;white-space:nowrap;">
                    â¬… à¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”
                </a>
            </div>
            <div id="db-status" class="supabase-badge">â³ à¸à¸³à¸¥à¸±à¸‡à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­â€¦</div>
        </header>

        <!-- Chat container -->
        <div class="chat-container card fade-up" style="animation-delay:120ms">

            <!-- Messages area -->
            <div class="messages" id="messages">
                <div class="message system">
                    <div class="bubble">
                        ğŸ‘‹ à¸ªà¸§à¸±à¸ªà¸”à¸µà¸„à¸£à¸±à¸š! à¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡à¹€à¸à¸µà¹ˆà¸¢à¸§à¸à¸±à¸šà¹€à¸­à¸à¸ªà¸²à¸£à¸—à¸µà¹ˆà¸„à¸¸à¸“à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹„à¸§à¹‰à¹„à¸”à¹‰à¹€à¸¥à¸¢<br />
                        <small style="color:var(--text-muted)">à¸£à¸°à¸šà¸šà¸ˆà¸°à¸„à¹‰à¸™à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸ˆà¸²à¸ Vector Database
                            à¹à¸¥à¹‰à¸§à¸•à¸­à¸šà¸à¸¥à¸±à¸š</small>
                    </div>
                </div>
            </div>

            <!-- Input area -->
            <div class="chat-input-area">
                <div class="chat-input-row">
                    <textarea id="chat-input"
                        placeholder="à¸à¸´à¸¡à¸à¹Œà¸„à¸³à¸–à¸²à¸¡à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸—à¸µà¹ˆà¸™à¸µà¹ˆâ€¦ à¹€à¸Šà¹ˆà¸™ 'à¸ªà¸±à¸à¸à¸²à¸„à¸·à¸­à¸­à¸°à¹„à¸£?' à¸«à¸£à¸·à¸­ 'à¸­à¸²à¸¢à¸¸à¸„à¸§à¸²à¸¡à¹ƒà¸™à¸„à¸”à¸µà¹à¸à¹ˆà¸‡à¸„à¸·à¸­à¸à¸µà¹ˆà¸›à¸µ?'"
                        rows="2" onkeydown="handleKey(event)"></textarea>
                    <button class="send-btn" id="send-btn" onclick="sendMessage()" title="à¸ªà¹ˆà¸‡ (Enter)">
                        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13" />
                            <polygon points="22 2 15 22 11 13 2 9 22 2" />
                        </svg>
                    </button>
                </div>
                <div class="chat-meta-row">
                    <span style="font-size:11px;color:var(--text-muted)">Enter = à¸ªà¹ˆà¸‡ Â· Shift+Enter =
                        à¸‚à¸¶à¹‰à¸™à¸šà¸£à¸£à¸—à¸±à¸”à¹ƒà¸«à¸¡à¹ˆ</span>
                    <div style="display:flex;gap:12px;align-items:center;">
                        <label style="font-size:12px;color:var(--text-muted)">
                            Top-K:
                            <select id="top-k"
                                style="background:var(--surface-2);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:2px 6px;font-size:12px;">
                                <option value="3">3</option>
                                <option value="5" selected>5</option>
                                <option value="10">10</option>
                            </select>
                        </label>
                        <label style="font-size:12px;color:var(--text-muted)">
                            Threshold:
                            <select id="threshold"
                                style="background:var(--surface-2);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:2px 6px;font-size:12px;">
                                <option value="0.5">0.5</option>
                                <option value="0.6">0.6</option>
                                <option value="0.7" selected>0.7</option>
                                <option value="0.8">0.8</option>
                            </select>
                        </label>
                        <button class="btn btn-ghost btn-sm" onclick="clearChat()">ğŸ—‘ï¸ à¸¥à¹‰à¸²à¸‡</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // â”€â”€ Init Supabase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const { createClient } = window.supabase;
        const db = createClient(AppConfig.supabaseUrl, AppConfig.supabaseAnonKey);

        // â”€â”€ Check DB connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function checkDb() {
            try {
                const { error } = await db.from("documents").select("id").limit(1);
                if (error) throw error;
                const { count } = await db.from("chunks").select("id", { count: "exact", head: true });
                setDbStatus(true, `ğŸŸ¢ à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹à¸¥à¹‰à¸§ Â· ${count ?? 0} chunks à¹ƒà¸™ database`);
            } catch {
                setDbStatus(false, "ğŸ”´ à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ Supabase à¹„à¸”à¹‰");
            }
        }

        function setDbStatus(ok, msg) {
            const el = document.getElementById("db-status");
            el.className = `supabase-badge ${ok ? "connected" : "error"}`;
            el.textContent = msg;
        }

        // â”€â”€ Key handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function handleKey(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // â”€â”€ Clear chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function clearChat() {
            const msgs = document.getElementById("messages");
            msgs.innerHTML = `
        <div class="message system">
          <div class="bubble">ğŸ”„ à¹à¸Šà¸—à¸–à¸¹à¸à¸¥à¹‰à¸²à¸‡à¹à¸¥à¹‰à¸§ â€” à¸–à¸²à¸¡à¸„à¸³à¸–à¸²à¸¡à¹ƒà¸«à¸¡à¹ˆà¹„à¸”à¹‰à¹€à¸¥à¸¢</div>
        </div>`;
        }

        // â”€â”€ Main send handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function sendMessage() {
            const input = document.getElementById("chat-input");
            const query = input.value.trim();
            if (!query) return;

            const topK = parseInt(document.getElementById("top-k").value);
            const threshold = parseFloat(document.getElementById("threshold").value);

            input.value = "";
            input.style.height = "auto";

            appendMessage("user", query);
            const thinkingEl = appendMessage("assistant", `<span class="thinking">à¸à¸³à¸¥à¸±à¸‡à¸„à¹‰à¸™à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥â€¦</span>`);
            document.getElementById("send-btn").disabled = true;

            try {
                // Call Edge Function (handles embedding + vector search server-side)
                const res = await fetch(AppConfig.edgeFunctionUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        action: "query",
                        question: query,
                        top_k: topK,
                        threshold: threshold,
                    }),
                });
                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.error || `Server error: ${res.status}`);
                }
                const result = await res.json();
                const chunks = result.results || [];

                // 3. Build response
                if (!chunks || chunks.length === 0) {
                    thinkingEl.querySelector(".bubble").innerHTML = buildNoResultsHtml(query);
                } else {
                    thinkingEl.querySelector(".bubble").innerHTML = buildResultsHtml(query, chunks);
                }

            } catch (err) {
                thinkingEl.querySelector(".bubble").innerHTML = `
          <div class="answer-error">âŒ à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ${escHtml(err.message)}</div>`;
            } finally {
                document.getElementById("send-btn").disabled = false;
                scrollToBottom();
            }
        }

        // â”€â”€ Build response HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function buildResultsHtml(query, chunks) {
            const topChunk = chunks[0];
            const sim = ((topChunk.similarity || 0) * 100).toFixed(1);

            const sourceList = chunks.map((c, i) => `
        <div class="source-item">
          <div class="source-header">
            <span class="source-rank">#${i + 1}</span>
            <span class="source-sim">${((c.similarity || 0) * 100).toFixed(1)}% à¸•à¸£à¸‡à¸à¸±à¸™</span>
          </div>
          <div class="source-text">${escHtml(c.content.slice(0, 250))}${c.content.length > 250 ? "â€¦" : ""}</div>
        </div>
      `).join("");

            return `
        <div class="answer-header">ğŸ” à¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡ ${chunks.length} à¸£à¸²à¸¢à¸à¸²à¸£ (à¸„à¸§à¸²à¸¡à¹ƒà¸à¸¥à¹‰à¹€à¸„à¸µà¸¢à¸‡à¸ªà¸¹à¸‡à¸ªà¸¸à¸” ${sim}%)</div>
        <div class="answer-context">
          <strong>à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸¡à¸²à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸”:</strong><br/>
          <blockquote>${escHtml(topChunk.content)}</blockquote>
        </div>
        <details class="sources-details">
          <summary>ğŸ“š à¹à¸«à¸¥à¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸” (${chunks.length} chunks)</summary>
          <div class="sources-list">${sourceList}</div>
        </details>
      `;
        }

        function buildNoResultsHtml(query) {
            return `
        <div class="answer-error">
          ğŸ” à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸š "<strong>${escHtml(query)}</strong>"<br/>
          <small style="color:var(--text-muted)">à¸¥à¸­à¸‡à¸¥à¸” threshold à¸«à¸£à¸·à¸­à¸­à¸±à¸›à¹‚à¸«à¸¥à¸”à¹€à¸­à¸à¸ªà¸²à¸£à¸—à¸µà¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¹ˆà¸­à¸™</small>
        </div>`;
        }

        // â”€â”€ Append message to chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function appendMessage(role, html) {
            const msgs = document.getElementById("messages");
            const div = document.createElement("div");
            div.className = `message ${role} fade-up`;
            div.innerHTML = `<div class="bubble">${html}</div>`;
            msgs.appendChild(div);
            scrollToBottom();
            return div;
        }

        function scrollToBottom() {
            const msgs = document.getElementById("messages");
            msgs.scrollTop = msgs.scrollHeight;
        }

        function escHtml(str) {
            const d = document.createElement("div");
            d.textContent = str;
            return d.innerHTML;
        }

        // â”€â”€ Start â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        checkDb();
    </script>
</body>

</html>